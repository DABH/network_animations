<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.rawgit.com/MaxArt2501/es6-math/master/es6-math.min.js"></script>
    <!--<script src="https://cdn.rawgit.com/jondavidjohn/hidpi-canvas-polyfill/master/dist/hidpi-canvas.min.js"></script>-->
    <script src="https://cdn.rawgit.com/konvajs/konva/1.7.6/konva.min.js"></script>
    <script src="config.js"></script>
    <script src="component.js"></script>
    <script src="components/bufferPackets.js"></script>
    <script src="components/dynamicLabels.js"></script>
    <script src="components/links.js"></script>
    <script src="components/receiver.js"></script>
    <script src="components/router.js"></script>
    <script src="components/sender.js"></script>
    <script src="components/windowSizePlot.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Networking Animation 1</title>
    <link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>
<div id="aligner">
    <div id="container"></div>
</div>
<script>
    function createStage() {
        return new Konva.Stage({
            container: 'container',
            width: config.width,
            height: config.height
        });
    }

    var fps    = 120.0;
    var uid    = 100;
    var time   = 0.0;
    var stop   = false;

    // sender
    var s_win    = 1.0;
    var s_out    = 0;
    var s_tx     = false;
    var s_lost   = 9999;
    var s_pktno  = 1;
    var s_dropc  = 0;

    // router
    var q_queue  = 0;
    var q_tx     = false;
    var q_util   = 0;
    var q_droppkt = -1;
    var q_buffer = 8;

    function createComponents(linkLayer, packetLayer, componentLayer) {
        addComponent(linkLayer, links());
        addComponent(componentLayer, sender());
        addComponent(componentLayer, receiver());
        addComponent(componentLayer, router());
        addComponent(componentLayer, windowSizePlot());
        addComponent(componentLayer, dynamicLabels(s_win, q_util));
        addComponent(componentLayer, bufferPackets(q_buffer));
    }

    var stage = createStage();
    var linkLayer = new Konva.Layer({}); // ha
    var packetLayer = new Konva.Layer({});
    var componentLayer = new Konva.Layer({});
    createComponents(linkLayer, packetLayer, componentLayer);
    stage.add(linkLayer);
    stage.add(packetLayer);
    stage.add(componentLayer);

    function drop_pkt() {
        if(s_lost === 9999)
            s_lost = s_pktno + s_out-2;

        s_dropc += 1;
        q_droppkt = q_queue-1;
        stage.find('#dropLabel')[0].x(30);
        stage.find('#dropLabel')[0].y(50);
        stage.find('#dropLabel')[0].visible(true);
        tx_packet("dropped",false);
    }

    function rem_queue() {
        if (!q_tx && q_queue > 0) {
            var o = stage.find('#QueuePkt' + q_queue.toString())[0];
            o.visible(false);
            componentLayer.draw();
            q_queue -= 1;
            if (q_droppkt === 0) {
                tx_packet("RouterPktI", true);
                q_droppkt = -1;
            } else {
                tx_packet("RouterPktI", false);
            }
            q_droppkt -= 1;
            if (q_droppkt > 0) {
                stage.find('#dropLabel')[0].x(stage.find('#QueuePkt' + q_droppkt.toString())[0].x()-10);
            }
            q_tx = true;
        }
    }

    function add_queue() {
        if (q_queue < q_buffer) {
            q_queue +=1;
            if (!q_tx) {  // Currently not transmitting packet
                rem_queue();
            } else {   // If currently transmitting -> queue
                var o = stage.find('#QueuePkt'+q_queue.toString())[0];
                o.visible(true);
                componentLayer.draw();
            }
        } else {
            drop_pkt();
        }
    }

    function createNewPacket(name, uid) {
        if(name === 'sender'){
            return new Konva.Rect({
                x: 163.80,
                y: 91,
                width: 12.15,
                height: 30,
                fill: 'blue',
                id: 'sender' + uid.toString()
            });
        }else if(name === 'RouterPktI'){
            return new Konva.Rect({
                x: 475.05,
                y: 93,
                width: 108.0,
                height: 26,
                fill: 'blue',
                id: 'RouterPkt' + uid.toString()
            });
        }else if(name === 'AckI'){
            return new Konva.Rect({
                x: 840.50,
                y: 24,
                width: 14.85,
                height: 14.85,
                fill: 'red',
                id: 'AckPkt' + uid.toString()
            });
        }else if(name === 'dropped'){
            var packet = new Konva.Rect({
                x: 432.05,
                y: 93,
                width: 12.15,
                height: 30,
                fill: 'blue',
                id: 'DroppedPkt' + uid.toString()
            });
            packet.setAttr('dy', 0);
            return packet;
        }
    }

    function recv_pkt(drop) {
        tx_packet("AckI", drop);
    }

    function recv_ack() {
        if (s_pktno >= s_lost) {
            s_win   = Math.trunc(s_win/2.0);
            s_lost  = 9999;
            s_out   = s_out - s_dropc - 1;
            s_dropc = 0;
        } else {
            if (s_win >= s_out) {
                s_win = s_win + 1.0/Math.trunc(s_win)+0.000001;
            }
            s_out -= 1;
            do_sender();
        }
        stage.find("#windowSizeLabel")[0].text('W = '+Math.trunc(10.0*s_win)/10.0);
        componentLayer.draw();
    }

    function tx_packet(name, drop) {
        var newPacket = createNewPacket(name, uid);
        newPacket.setAttrs({
            active: true,
            tx_done: false,
            drop: drop
        });
        packetLayer.add(newPacket);
        var anim;
        if(name === 'sender') {
            anim = new Konva.Animation(function() {
                if (!newPacket.getAttr('active'))
                    return;

                newPacket.x(newPacket.x() + 2.0 * (430.0 - 164.0) / fps);

                if (newPacket.x() > 430.0) {
                    add_queue();
                    newPacket.destroy();
                    this.stop();
                }

                if (!newPacket.getAttr('tx_done') && newPacket.x() > 182.0) {
                    newPacket.setAttr('tx_done', true);
                    s_tx = false;
                    do_sender();
                }
            }, packetLayer);
        }else if(name === 'RouterPktI'){
            anim = new Konva.Animation(function() {
                if (!newPacket.getAttr('active'))
                    return;

                newPacket.x(newPacket.x() + (830.0-515.0)/fps);

                if (drop){
                    stage.find('#dropLabel')[0].x(stage.find('#QueuePkt1')[0].x()-10 + newPacket.x() - 475.05);
                }

                if(newPacket.x() > 830.0){
                    recv_pkt(drop);
                    newPacket.destroy();
                    this.stop();
                }

                if(!newPacket.getAttr('tx_done') && newPacket.x() > 590.0){
                    newPacket.setAttr('tx_done', true);
                    q_tx = false;
                    rem_queue();
                }
            }, packetLayer);
        }else if(name === 'AckI'){
            anim = new Konva.Animation(function() {
                if (!newPacket.getAttr('active'))
                    return;

                if(drop){
                    stage.find('#dropLabel')[0].x(newPacket.x() - 70);
                    stage.find('#dropLabel')[0].y(newPacket.y() - 20);
                }

                newPacket.x(newPacket.x() - (845.0-164.0)/fps/1.33);

                if(newPacket.x() < 164.0){
                    recv_ack();
                    if(drop)
                        stage.find('#dropLabel')[0].visible(false);
                    newPacket.destroy();
                    this.stop();
                }
            }, packetLayer);
        }else if(name === 'dropped') {
            anim = new Konva.Animation(function() {
                if (!newPacket.getAttr('active'))
                    return;

                newPacket.setAttr('dy', newPacket.getAttr('dy') + 2);
                newPacket.y(93 + newPacket.getAttr('dy'));

                if (newPacket.getAttr('dy') > 200) {
                    newPacket.destroy();
                    this.stop();
                }
            }, packetLayer);
        }
        anim.start();
        uid += 1;
    }

    function do_sender() {
        if(stop)
            return;
        if(!s_tx && s_out < Math.trunc(s_win)) {
            tx_packet("sender",false);
            s_out += 1;
            s_tx = true;
            s_pktno += 1;
        }
    }

    function updatePlotAndUtilization() {

        // Check if over, if yes stop
        if(stop)
            return;

        // Plot graph
        time += 5.0/fps;
        stage.find('#windowSizeCurve')[0].points(stage.find('#windowSizeCurve')[0].points().concat([89+time, 440.0-s_win*10.0]));
        if(time > 695)
            stop = true;

        // Update Utilization
        var f = 0.01*30.0/fps;
        if(q_tx){
            q_util = q_util*(1-f)+ f;
        } else {
            q_util = q_util*(1-f);
        }
        stage.find('#utilizationLabel')[0].text('util = '+Math.trunc(q_util*20.0+0.5)*5+'%');
        componentLayer.draw();
    }

    document.addEventListener('keydown', function(event) {
        const key = event.key;
        if (key === 'ArrowRight') {
            fps = 40.0;
        }
        if (key === 'ArrowLeft') {
            fps = 360.0;
        }
        if (key === 'ArrowDown') {
            fps = 120.0;
        }
    });

    window.setInterval(updatePlotAndUtilization, 5.0/fps * 1000.0);
    do_sender();
</script>

</body>

</html>