<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.rawgit.com/konvajs/konva/1.7.6/konva.min.js"></script>
    <script src="https://rawgit.com/konvajs/greensock-plugin/master/KonvaPlugin.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenLite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TimelineLite.min.js"></script>
    <script src="config.js"></script>
    <script src="component.js"></script>
    <script src="components/bufferPackets.js"></script>
    <script src="components/dynamicLabels.js"></script>
    <script src="components/links.js"></script>
    <script src="components/receiver.js"></script>
    <script src="components/router.js"></script>
    <script src="components/sender.js"></script>
    <script src="components/windowSizePlot.js"></script>
    <meta charset="utf-8">
    <title>Networking Animation 1</title>
    <link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>
<div id="aligner">
    <div id="container"></div>
</div>
<script>
    function createStage() {
        return new Konva.Stage({
            container: 'container',
            width: config.width,
            height: config.height
        });
    }

    var fps    = 120;
    var uid    = 100;
    var time   = 0;
    var stop   = false;

    // sender
    var s_win    = 1;
    var s_out    = 0;
    var s_tx     = false;
    var s_lost   = 9999;
    var s_pktno  = 1;
    var s_dropc  = 0;

    // router
    var q_queue  = 0;
    var q_tx     = false;
    var q_util   = 0;
    var q_droppkt = -1;
    var q_buffer = 8;

    function createComponents(linkLayer, packetLayer, componentLayer) {
        addComponent(linkLayer, links());
        addComponent(componentLayer, sender());
        addComponent(componentLayer, receiver());
        addComponent(componentLayer, router());
        addComponent(componentLayer, windowSizePlot());
        addComponent(componentLayer, dynamicLabels(s_win, q_util));
        addComponent(componentLayer, bufferPackets(q_buffer));
    }

    var stage = createStage();
    var linkLayer = new Konva.Layer(); // ha
    var packetLayer = new Konva.Layer();
    var componentLayer = new Konva.Layer();
    createComponents(linkLayer, packetLayer, componentLayer);
    stage.add(linkLayer);
    stage.add(packetLayer);
    stage.add(componentLayer);

    function rem_queue() {
        if (!q_tx && q_queue > 0) {
            var o = stage.find('#QueuePkt' + q_queue.toString())[0];
            o.visible(false);
            componentLayer.draw();
            q_queue -= 1;
            if (q_droppkt === 0) {
                //tx_packet("RouterPktI", true);
                console.log('h1');
                q_droppkt = -1;
            } else {
                console.log('h2');
                tx_packet("RouterPktI", false);
            }
            q_droppkt -= 1;
            if (q_droppkt > 0) {
                console.log('h3');
                //_level0.SenderShapeTop.dropTxt._x = 480 - q_droppkt * 120 / q_buffer;
            }
            q_tx = true;
        }
    }

    function add_queue() {
        if (q_queue < q_buffer) {
            q_queue +=1;
            if (!q_tx) {  // Currently not transmitting packet
                console.log('rq');
                rem_queue();
            } else {   // If currently transmitting -> queue
                console.log('else');
                var o = stage.find('#QueuePkt'+q_queue.toString())[0];
                o.visible(true);
                componentLayer.draw();
            }
        } else {
            console.log('e2');
            //drop_pkt();
        }
    }

    function createNewPacket(name, uid) {
        if(name === 'sender'){
            return new Konva.Rect({
                x: 164,
                y: 91,
                width: 12,
                height: 30,
                fill: 'blue',
                id: 'sender' + uid.toString()
            });
        }else if(name === 'RouterPktI'){
            return new Konva.Rect({
                x: 475,
                y: 93,
                width: 110,
                height: 26,
                fill: 'blue',
                id: 'RouterPkt' + uid.toString()
            });
        }else if(name === 'AckI'){
            return new Konva.Rect({
                x: 841,
                y: 24,
                width: 15,
                height: 15,
                fill: 'red',
                id: 'AckPkt' + uid.toString()
            });
        }
    }

    function recv_pkt(drop) {
        tx_packet("AckI", drop);
    }

    function recv_ack() {
        if (s_pktno >= s_lost) {
            s_win   = Math.floor(s_win/2.0);
            s_lost  = 9999;
            s_out   = s_out - s_dropc -1;
            s_dropc = 0;
        } else {
            if (s_win >= s_out) {
                s_win = s_win + 1.0/Math.floor(s_win)+0.0000001;
            }
            s_out -= 1;
            do_sender();
        }
        //console.log(stage.find("#windowSizeLabel")[0]);
        stage.find("#windowSizeLabel")[0].text('W = '+Math.floor(10*s_win)/10.0);
        componentLayer.draw();
    }

    function tx_packet(name, drop) {
        var newPacket = createNewPacket(name, uid);
        newPacket.setAttrs({
            active: true,
            tx_done: false,
            drop: drop
        });
        packetLayer.add(newPacket);
        if(name === 'sender') {
            var anim = new Konva.Animation(function (frame) {
                if (!newPacket.getAttr('active'))
                    return;

                newPacket.setX(newPacket.getAttr('x') + 2 * (430 - 164) / fps);

                if (newPacket.getAttr('x') > 430) {
                    //console.log('add queue');
                    add_queue();
                    newPacket.destroy();
                    this.stop();
                }

                if (!newPacket.getAttr('tx_done') && newPacket.getAttr('x') > 182) {
                    newPacket.setAttr('tx_done', true);
                    s_tx = false;
                    do_sender();
                }
            }, packetLayer);
            anim.start();
        }else if(name === 'RouterPktI'){
            var anim = new Konva.Animation(function (frame) {
                if (!newPacket.getAttr('active'))
                    return;

                newPacket.setX(newPacket.getAttr('x') + (830-515)/fps);

                /*if (drop) {
                    _level0.SenderShapeTop.dropTxt._x = xpos-20;
                }*/

                if(newPacket.getAttr('x') > 830){
                    recv_pkt(drop);
                    console.log('rp!');
                    newPacket.destroy();
                    this.stop();
                }

                if(!newPacket.getAttr('tx_done') && newPacket.getAttr('x') > 590){
                    newPacket.setAttr('tx_done', true);
                    q_tx = false;
                    rem_queue();
                }
            }, packetLayer);
            anim.start();
        }else if(name === 'AckI'){
            var anim = new Konva.Animation(function (frame) {
                if (!newPacket.getAttr('active'))
                    return;

                /*if(drop){
                    _level0.SenderShapeTop.dropTxt._x = _x-70;
                    _level0.SenderShapeTop.dropTxt._y = _y-60;
                }*/

                newPacket.setX(newPacket.getAttr('x') - (845-164)/fps);

                if(newPacket.getAttr('x') < 164){
                    console.log('ra!');
                    recv_ack();
                    //if(drop) _level0.SenderShapeTop.dropTxt._visible = false;
                    newPacket.destroy();
                    this.stop();
                }
            }, packetLayer);
            anim.start();
        }
        uid += 1;
    }

    function do_sender() {
        if(stop)
            return;
        if(!s_tx && s_out < Math.floor(s_win)) {
            tx_packet("sender",false);
            s_out += 1;
            s_tx = true;
            s_pktno += 1;
        }
    }

    function updatePlotAndUtilization() {
        /*if (Key.isDown(Key.RIGHT)) {
            _level0.fps = 30;
        }
        if (Key.isDown(Key.LEFT)) {
            _level0.fps = 360;
        }
        if (Key.isDown(Key.DOWN)) {
            _level0.fps = 120;
        }*/

        // Check if over, if yes stop
        if(stop)
            return;

        // Plot graph
        time += 5.0/fps;
        stage.find('#windowSizeCurve')[0].points(stage.find('#windowSizeCurve')[0].points().concat([89+time, 440.0-s_win*10.0]));
        if(time > 695)
            stop = true;

        // Update Utilization
        f = 0.01*30/fps;
        if(q_tx){
            q_util = q_util*(1-f)+ f;
        } else {
            q_util = q_util*(1-f);
        }
        stage.find('#utilizationLabel')[0].text('util = '+Math.floor(q_util*20.0+0.5)*5+'%');
        componentLayer.draw();
    }

    window.setInterval(updatePlotAndUtilization, 5.0/fps * 1000.0);
    do_sender();
</script>

</body>

</html>